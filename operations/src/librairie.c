/*
 * librairie.c
 *
 *  Created on: 16 mars 2019
 *      Author: lisag
 */
#include "librairie.h"
#include "operations.h"

#define NB_COEFF 10
void internal_reduction(int *rop, int *op) { // int 64 et int 128

	int tmp_q[NB_COEFF][5]; //uint64_t sans [5]
	int tmp_zero[NB_COEFF][5]; //int 128 sans [5]
	int tempo_res[10][5];
	int *tempo_res2;
	//~ computation of : op*neg_inv_ri_rep_coeff mod((X^n - c), mont_phi)
	int constantes[10][5] = {{0,0,3,265232453,1301075987},
								{0,0,2,1966732964,382641100},
								{0,0,1,463745936,29416710},
								{0,0,0,566067269,1998375154},
								{0,0,0,857916278,688778796},
								{0,0,1,614080720,1951589506},
								{0,0,1,2127892607,1859236758},
								{0,0,1,1380410500,1747721376},
								{0,0,1,1844767645,1907583688},
								{0,0,2,2050867106,1873368180}
	};

	int constante_mult[5] = {0,0, 3, 2147483647, 2147483646};

	int indice = 0;
	for (int j = 0; j < NB_COEFF; j ++) {
		for(int i = 0 ; i < NB_COEFF; i ++){
			indice = i - j;
			if(indice < 0){
				indice = indice + NB_COEFF;
			}
			mult_128(&op[i], constantes[indice],tempo_res[i]);
		}
		add(tempo_res2 ,10, tempo_res[0],tempo_res[1],tempo_res[2],tempo_res[3],tempo_res[4],tempo_res[5],tempo_res[6],tempo_res[7],tempo_res[8],tempo_res[9]);
		if(j < 8) {
			mult_128(&tmp_q[j][0], tempo_res2, constante_mult);
		}

	}









//	tmp_q[1] = ((uint64_t)op[0] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[1] * {0,0,3,265232453,1301075987}) + ((((uint64_t)op[2] * {0,0,2,1966732964,382641100}) + ((uint64_t)op[3] * {0,0,1,463745936,29416710}) + ((uint64_t)op[4] * {0,0,0,566067269,1998375154}) + ((uint64_t)op[5] * {0,0,0,857916278,688778796}) + ((uint64_t)op[6] * {0,0,1,614080720,1951589506}) + ((uint64_t)op[7] * {0,0,1,2127892607,1859236758}) + ((uint64_t)op[8] * {0,0,1,1380410500,1747721376}) + ((uint64_t)op[9] * {0,0,1,1844767645,1907583688})) * {0,0, 3, 2147483647, 2147483646});
//	tmp_q[2] = ((uint64_t)op[0] * {0,0,1,1844767645,1907583688}) + ((uint64_t)op[1] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[2] * {0,0,3,265232453,1301075987}) + ((((uint64_t)op[3] * {0,0,2,1966732964,382641100}) + ((uint64_t)op[4] * {0,0,1,463745936,29416710}) + ((uint64_t)op[5] * {0,0,0,566067269,1998375154}) + ((uint64_t)op[6] * {0,0,0,857916278,688778796}) + ((uint64_t)op[7] * {0,0,1,614080720,1951589506}) + ((uint64_t)op[8] * {0,0,1,2127892607,1859236758}) + ((uint64_t)op[9] * {0,0,1,1380410500,1747721376})) * {0,0, 3, 2147483647, 2147483646});
//	tmp_q[3] = ((uint64_t)op[0] * {0,0,1,1380410500,1747721376}) + ((uint64_t)op[1] * {0,0,1,1844767645,1907583688}) + ((uint64_t)op[2] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[3] * {0,0,3,265232453,1301075987}) + ((((uint64_t)op[4] * {0,0,2,1966732964,382641100}) + ((uint64_t)op[5] * {0,0,1,463745936,29416710}) + ((uint64_t)op[6] * {0,0,0,566067269,1998375154}) + ((uint64_t)op[7] * {0,0,0,857916278,688778796}) + ((uint64_t)op[8] * {0,0,1,614080720,1951589506}) + ((uint64_t)op[9] * {0,0,1,2127892607,1859236758})) * {0,0, 3, 2147483647, 2147483646});
//	tmp_q[4] = ((uint64_t)op[0] * {0,0,1,2127892607,1859236758}) + ((uint64_t)op[1] * {0,0,1,1380410500,1747721376}) + ((uint64_t)op[2] * {0,0,1,1844767645,1907583688}) + ((uint64_t)op[3] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[4] * {0,0,3,265232453,1301075987}) + ((((uint64_t)op[5] * {0,0,2,1966732964,382641100}) + ((uint64_t)op[6] * {0,0,1,463745936,29416710}) + ((uint64_t)op[7] * {0,0,0,566067269,1998375154}) + ((uint64_t)op[8] * {0,0,0,857916278,688778796}) + ((uint64_t)op[9] * {0,0,1,614080720,1951589506})) * {0,0, 3, 2147483647, 2147483646});
//	tmp_q[5] = ((uint64_t)op[0] * {0,0,1,614080720,1951589506}) + ((uint64_t)op[1] * {0,0,1,2127892607,1859236758}) + ((uint64_t)op[2] * {0,0,1,1380410500,1747721376}) + ((uint64_t)op[3] * {0,0,1,1844767645,1907583688}) + ((uint64_t)op[4] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[5] * {0,0,3,265232453,1301075987}) + ((((uint64_t)op[6] * {0,0,2,1966732964,382641100}) + ((uint64_t)op[7] * {0,0,1,463745936,29416710}) + ((uint64_t)op[8] * {0,0,0,566067269,1998375154}) + ((uint64_t)op[9] * {0,0,0,857916278,688778796})) * {0,0, 3, 2147483647, 2147483646});
//	tmp_q[6] = ((uint64_t)op[0] * {0,0,0,857916278,688778796}) + ((uint64_t)op[1] * {0,0,1,614080720,1951589506}) + ((uint64_t)op[2] * {0,0,1,2127892607,1859236758}) + ((uint64_t)op[3] * {0,0,1,1380410500,1747721376}) + ((uint64_t)op[4] * {0,0,1,1844767645,1907583688}) + ((uint64_t)op[5] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[6] * {0,0,3,265232453,1301075987}) + ((((uint64_t)op[7] * {0,0,2,1966732964,382641100}) + ((uint64_t)op[8] * {0,0,1,463745936,29416710}) + ((uint64_t)op[9] * {0,0,0,566067269,1998375154})) * {0,0, 3, 2147483647, 2147483646});
//	tmp_q[7] = ((uint64_t)op[0] * {0,0,0,566067269,1998375154}) + ((uint64_t)op[1] * {0,0,0,857916278,688778796}) + ((uint64_t)op[2] * {0,0,1,614080720,1951589506}) + ((uint64_t)op[3] * {0,0,1,2127892607,1859236758}) + ((uint64_t)op[4] * {0,0,1,1380410500,1747721376}) + ((uint64_t)op[5] * {0,0,1,1844767645,1907583688}) + ((uint64_t)op[6] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[7] * {0,0,3,265232453,1301075987}) + ((((uint64_t)op[8] * {0,0,2,1966732964,382641100}) + ((uint64_t)op[9] * {0,0,1,463745936,29416710})) * {0,0, 3, 2147483647, 2147483646});


//	tmp_q[8] = ((uint64_t)op[0] * {0,0,1,463745936,29416710}) + ((uint64_t)op[1] * {0,0,0,566067269,1998375154}) + ((uint64_t)op[2] * {0,0,0,857916278,688778796}) + ((uint64_t)op[3] * {0,0,1,614080720,1951589506}) + ((uint64_t)op[4] * {0,0,1,2127892607,1859236758}) + ((uint64_t)op[5] * {0,0,1,1380410500,1747721376}) + ((uint64_t)op[6] * {0,0,1,1844767645,1907583688}) + ((uint64_t)op[7] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[8] * {0,0,3,265232453,1301075987}) + ((uint64_t)op[9] * 9999690312599124072UL);
//	tmp_q[9] = ((uint64_t)op[0] * {0,0,2,1966732964,382641100}) + ((uint64_t)op[1] * {0,0,1,463745936,29416710}) + ((uint64_t)op[2] * {0,0,0,566067269,1998375154}) + ((uint64_t)op[3] * {0,0,0,857916278,688778796}) + ((uint64_t)op[4] * {0,0,1,614080720,1951589506}) + ((uint64_t)op[5] * {0,0,1,2127892607,1859236758}) + ((uint64_t)op[6] * {0,0,1,1380410500,1747721376}) + ((uint64_t)op[7] * {0,0,1,1844767645,1907583688}) + ((uint64_t)op[8] * {0,0,2,2050867106,1873368180}) + ((uint64_t)op[9] * {0,0,3,265232453,1301075987});

//	//~ computation of : tmp_q*red_int_coeff mod(X^n - c)
//	tmp_zero[0] = ((int128)tmp_q[0] * {0,0,0,417928,566989053}) - ((-((int128)tmp_q[1] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[2] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[3] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[4] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[5] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[6] * {0,0,0,859125,578910610}) - ((int128)tmp_q[7] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[8] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[9] * {0,0,0,511533,1153479332})) * 2);
//	tmp_zero[1] = ((int128)tmp_q[0] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[1] * {0,0,0,417928,566989053}) - ((-((int128)tmp_q[2] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[3] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[4] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[5] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[6] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[7] * {0,0,0,859125,578910610}) - ((int128)tmp_q[8] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[9] * {0,0,0,511533,1153479332})) * 2);
//	tmp_zero[2] = -((int128)tmp_q[0] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[1] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[2] * {0,0,0,417928,566989053}) - ((-((int128)tmp_q[3] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[4] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[5] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[6] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[7] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[8] * {0,0,0,859125,578910610}) - ((int128)tmp_q[9] * {0,0,0,1256881,965507168})) * 2);
//	tmp_zero[3] = -((int128)tmp_q[0] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[1] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[2] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[3] * {0,0,0,417928,566989053}) - ((-((int128)tmp_q[4] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[5] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[6] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[7] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[8] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[9] * {0,0,0,859125,578910610})) * 2);
//	tmp_zero[4] = -((int128)tmp_q[0] * {0,0,0,859125,578910610}) - ((int128)tmp_q[1] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[2] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[3] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[4] * {0,0,0,417928,566989053}) - ((-((int128)tmp_q[5] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[6] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[7] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[8] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[9] * {0,0,0, 1197261, 370139154})) * 2);
//	tmp_zero[5] = ((int128)tmp_q[0] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[1] * {0,0,0,859125,578910610}) - ((int128)tmp_q[2] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[3] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[4] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[5] * {0,0,0,417928,566989053}) - ((-((int128)tmp_q[6] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[7] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[8] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[9] * {0,0,0,797746, 1154618716})) * 2);
//	tmp_zero[6] = -((int128)tmp_q[0] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[1] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[2] * {0,0,0,859125,578910610}) - ((int128)tmp_q[3] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[4] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[5] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[6] * {0,0,0,417928,566989053}) - ((-((int128)tmp_q[7] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[8] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[9] * {0,0,0, 494195, 168469458})) * 2);
//	tmp_zero[7] = ((int128)tmp_q[0] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[1] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[2] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[3] * {0,0,0,859125,578910610}) - ((int128)tmp_q[4] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[5] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[6] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[7] * {0,0,0,417928,566989053}) - ((-((int128)tmp_q[8] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[9] * {0,0,0, 385707, 586693830})) * 2);
//	tmp_zero[8] = -((int128)tmp_q[0] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[1] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[2] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[3] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[4] * {0,0,0,859125,578910610}) - ((int128)tmp_q[5] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[6] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[7] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[8] * {0,0,0,417928,566989053}) + ((int128)tmp_q[9] * 2157646802709080L);
//	tmp_zero[9] = -((int128)tmp_q[0] * {0,0,0, 502366, 631043372}) - ((int128)tmp_q[1] * {0,0,0, 385707, 586693830}) + ((int128)tmp_q[2] * {0,0,0, 494195, 168469458}) - ((int128)tmp_q[3] * {0,0,0,797746, 1154618716}) + ((int128)tmp_q[4] * {0,0,0, 1197261, 370139154}) - ((int128)tmp_q[5] * {0,0,0,859125,578910610}) - ((int128)tmp_q[6] * {0,0,0,1256881,965507168}) - ((int128)tmp_q[7] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[8] * {0,0,0,511533,1153479332}) + ((int128)tmp_q[9] * {0,0,0,417928,566989053});
//
//	//~ computation of : (op + tmp_zero)/mont_phi
//	rop[0] = (op[0] + tmp_zero[0]) >> WORD_SIZE;
//	rop[1] = (op[1] + tmp_zero[1]) >> WORD_SIZE;
//	rop[2] = (op[2] + tmp_zero[2]) >> WORD_SIZE;
//	rop[3] = (op[3] + tmp_zero[3]) >> WORD_SIZE;
//	rop[4] = (op[4] + tmp_zero[4]) >> WORD_SIZE;
//	rop[5] = (op[5] + tmp_zero[5]) >> WORD_SIZE;
//	rop[6] = (op[6] + tmp_zero[6]) >> WORD_SIZE;
//	rop[7] = (op[7] + tmp_zero[7]) >> WORD_SIZE;
//	rop[8] = (op[8] + tmp_zero[8]) >> WORD_SIZE;
//	rop[9] = (op[9] + tmp_zero[9]) >> WORD_SIZE;
}
